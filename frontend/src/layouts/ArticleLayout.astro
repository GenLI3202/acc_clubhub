---
// src/layouts/ArticleLayout.astro
// 文章详情页布局

import BaseLayout from './BaseLayout.astro';
import { t, type Locale } from '../lib/i18n';

interface Props {
  title: string;
  date?: Date | string; // 支持 Date 对象和 ISO 字符串
  author?: string;
  cover?: string;
  lang: Locale;
  backLink: string;
  backLabel?: string;
  xiaohongshuUrl?: string;
}

const { title, date, author, cover, lang, backLink, backLabel, xiaohongshuUrl } = Astro.props;

// 安全转换日期：支持 Date 对象和字符串
const dateObj = date ? (date instanceof Date ? date : new Date(date)) : null;
const isValidDate = dateObj && !isNaN(dateObj.getTime());

const formattedDate = isValidDate
  ? dateObj.toLocaleDateString(lang === 'de' ? 'de-DE' : lang === 'en' ? 'en-US' : 'zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;
---

<BaseLayout title={title} lang={lang}>
  <article class="article">
    <header class="article-header">
      <a href={backLink} class="article-back">
        ← {backLabel || t(lang, 'content.back')}
      </a>

      <h1>{title}</h1>

      <div class="article-meta-row">
        {(formattedDate || author) && (
          <div class="article-meta">
            {formattedDate && <time>{formattedDate}</time>}
            {author && <span class="article-author">by {author}</span>}
          </div>
        )}

        {xiaohongshuUrl && (
          <a href={xiaohongshuUrl} target="_blank" rel="noopener" class="xhs-link">
            小红书 (Xiaohongshu) ↗
          </a>
        )}
      </div>
    </header>

    {cover && (
      <img src={cover} alt={title} class="article-cover" />
    )}

    <div class="article-content prose">
      <slot />
    </div>
  </article>
</BaseLayout>

<style>
  .article {
    max-width: 800px;
    margin: 0 auto;
  }

  .article-header {
    margin-bottom: var(--space-lg);
  }

  .article-back {
    display: inline-block;
    font-size: 0.9rem;
    color: var(--color-primary);
    margin-bottom: var(--space-md);
    transition: color 0.2s ease;
  }

  .article-back:hover {
    color: var(--color-accent);
    text-decoration: none;
  }

  .article-header h1 {
    font-size: 2.2rem;
    line-height: 1.2;
    margin-bottom: var(--space-sm);
  }

  .article-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-md);
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    font-size: 0.9rem;
    color: #666;
  }

  .article-author {
    font-style: italic;
  }

  .xhs-link {
    display: inline-block;
    padding: 2px 8px;
    background-color: #ff2442;
    color: white;
    font-size: 0.8rem;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .xhs-link:hover {
    opacity: 0.9;
    text-decoration: none;
    color: white;
  }

  .article-cover {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: var(--radius-aero);
    border: 2px solid var(--color-border-rough);
    margin-bottom: var(--space-lg);
  }

  /* Article content prose styles */
  .article-content {
    font-size: 1.05rem;
    line-height: 1.8;
  }

  .article-content :global(h2) {
    font-size: 1.5rem;
    margin-top: var(--space-xl);
    margin-bottom: var(--space-md);
  }

  .article-content :global(h3) {
    font-size: 1.25rem;
    margin-top: var(--space-lg);
    margin-bottom: var(--space-sm);
  }

  .article-content :global(p) {
    margin-bottom: var(--space-md);
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: var(--space-md);
    padding-left: 1.5rem;
  }

  .article-content :global(li) {
    margin-bottom: var(--space-xs);
  }

  .article-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--space-md);
  }

  .article-content :global(th),
  .article-content :global(td) {
    padding: var(--space-sm);
    border: 1px solid var(--color-border-rough);
    text-align: left;
  }

  .article-content :global(th) {
    background: rgba(45, 93, 155, 0.1);
    font-weight: 600;
  }

  .article-content :global(blockquote) {
    border-left: 4px solid var(--color-accent);
    margin: var(--space-md) 0;
    padding-left: var(--space-md);
    font-style: italic;
    color: #555;
  }

  .article-content :global(code) {
    background: rgba(0, 0, 0, 0.05);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.9em;
  }

  .article-content :global(pre) {
    background: #1a1a1a;
    color: #f8f8f2;
    padding: var(--space-md);
    border-radius: 6px;
    overflow-x: auto;
    margin-bottom: var(--space-md);
  }

  .article-content :global(pre code) {
    background: none;
    padding: 0;
  }
</style>
